name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Make build.sh executable
        run: chmod +x build.sh

      - name: Determine Tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using pushed tag: ${{ github.ref_name }}"
          else
            latest_tag=$(git describe --tags --abbrev=0)
            echo "tag_name=$latest_tag" >> $GITHUB_OUTPUT
            echo "Using latest tag: $latest_tag"
          fi

      - name: Extract changelog for this tag
        run: |
          chmod +x script/extract_changelog.sh
          {
            echo "# Release Notes | 发布说明"
            echo
            script/extract_changelog.sh "${{ steps.tag.outputs.tag_name }}"
          } > RELEASE_NOTE.md

          echo "====== Extracted Release Notes ======"
          cat RELEASE_NOTE.md
          echo "====================================="

      - name: Run Build Script
        run: ./build.sh

      - name: Prepare artifacts
        run: |
          mkdir artifacts
          cp build/* artifacts/

      - name: Create Draft Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "Release ${{ steps.tag.outputs.tag_name }}"
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ steps.tag.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
