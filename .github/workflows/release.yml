name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: Make build.sh executable
        run: chmod +x build.sh

      - name: Determine Tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # 直接从 push 的 tag 获取
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using pushed tag: ${{ github.ref_name }}"
          else
            # 手动触发则尝试自动获取最后一个 tag
            latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || true)

            if [[ -z "$latest_tag" ]]; then
              echo "No tags found, fallback to v0.1.0"
              latest_tag="v0.1.0"
            fi

            echo "tag_name=$latest_tag" >> $GITHUB_OUTPUT
            echo "Using tag: $latest_tag"
          fi

      - name: Extract changelog for this tag
        run: |
          chmod +x script/extract_changelog.sh
          {
            echo
            script/extract_changelog.sh "${{ steps.tag.outputs.tag_name }}"
          } > RELEASE_NOTE.md

          echo "====== Extracted Release Notes ======"
          cat RELEASE_NOTE.md
          echo "====================================="

      - name: Run Build Script
        run: ./build.sh

      - name: Prepare artifacts
        run: |
          mkdir artifacts
          cp build/* artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "Release ${{ steps.tag.outputs.tag_name }}"
          body_path: RELEASE_NOTE.md
          files: artifacts/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
